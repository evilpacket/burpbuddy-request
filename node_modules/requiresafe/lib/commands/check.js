/*
Checks your npm dependencies for vulnerabilities by sending your package.json to the `requiresafe` service for validation.

If you've create a `npm-shrinkwrap.json` file using the `npm shrinkwrap` that will be sent along as well for more precise validation of versions.
*/
var fs = require('fs');
var path = require('path');
var findRoot = require('find-root');
var tryIt = require('tryit');
var pick = require('amp-pick');


// Just build up some help text and return it
module.exports = function (config, callback) {
    var root = findRoot(process.cwd());
    var result = {};
    var packageFile = path.join(root, 'package.json');
    var shrinkWrap = path.join(root, 'npm-shrinkwrap.json');

    tryIt(function () {
        result.package = pick(JSON.parse(fs.readFileSync(packageFile, 'utf8')), ['name', 'version', 'dependencies', 'devDependencies']);
    });
    tryIt(function () {
        result.shrinkWrap = JSON.parse(fs.readFileSync(shrinkWrap, 'utf8'));
    });

    if (!result.package) {
        return callback(new Error('Unable to read package.json file: ' + packageFile));
    }

    config.api.checkDependencies(result, function (err, results) {
        if (err) {
            return callback(err);
        }

        if (results === 'OK') {
            return callback(null, 'âœ” No vulnerabilities found');
        }

        console.log(results);
        process.exit(1);
    });
};
